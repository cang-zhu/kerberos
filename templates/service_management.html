{% extends "base.html" %}

{% block title %}服务管理{% endblock %}

{% block additional_style %}
<style>
    .card {
        margin-bottom: 20px;
    }
    .status-badge {
        font-size: 0.9rem;
        padding: 0.4rem 0.6rem;
    }
    .service-card {
        transition: all 0.3s ease;
    }
    .service-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .service-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    .service-logs {
        max-height: 200px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">服务管理</h5>
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回仪表板
                </a>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i> 在此页面您可以管理 Hadoop 和 Hive 服务的启动、停止和状态监控。
                </div>
                
                <!-- 快速操作按钮 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <button class="btn btn-success me-2" onclick="startAllServices()">
                            <i class="bi bi-play-fill"></i> 启动所有服务
                        </button>
                        <button class="btn btn-danger me-2" onclick="stopAllServices()">
                            <i class="bi bi-stop-fill"></i> 停止所有服务
                        </button>
                        <button class="btn btn-primary me-2" onclick="refreshStatus()">
                            <i class="bi bi-arrow-clockwise"></i> 刷新状态
                        </button>
                    </div>
                </div>
                
                <!-- 服务状态概览 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">服务状态概览</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="p-3">
                                            <h3 id="runningCount">4</h3>
                                            <p class="text-success mb-0">运行中</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3">
                                            <h3 id="stoppedCount">2</h3>
                                            <p class="text-danger mb-0">已停止</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3">
                                            <h3 id="warningCount">1</h3>
                                            <p class="text-warning mb-0">警告</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3">
                                            <h3 id="totalCount">7</h3>
                                            <p class="text-muted mb-0">总计</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hadoop 服务 -->
                <h5 class="mb-3">Hadoop 服务</h5>
                <div class="row mb-4">
                    <!-- NameNode -->
                    <div class="col-md-4 mb-3">
                        <div class="card service-card">
                            <div class="card-body text-center">
                                <i class="bi bi-hdd-network service-icon text-primary"></i>
                                <h5>NameNode</h5>
                                <span class="badge bg-success status-badge mb-3">运行中</span>
                                <p class="text-muted">管理 HDFS 命名空间</p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-danger" onclick="stopService('namenode')">
                                        <i class="bi bi-stop-fill"></i> 停止
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="restartService('namenode')">
                                        <i class="bi bi-arrow-clockwise"></i> 重启
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showLogs('namenode')">
                                        <i class="bi bi-file-text"></i> 日志
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DataNode -->
                    <div class="col-md-4 mb-3">
                        <div class="card service-card">
                            <div class="card-body text-center">
                                <i class="bi bi-hdd-stack service-icon text-success"></i>
                                <h5>DataNode</h5>
                                <span class="badge bg-success status-badge mb-3">运行中</span>
                                <p class="text-muted">存储和管理数据块</p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-danger" onclick="stopService('datanode')">
                                        <i class="bi bi-stop-fill"></i> 停止
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="restartService('datanode')">
                                        <i class="bi bi-arrow-clockwise"></i> 重启
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showLogs('datanode')">
                                        <i class="bi bi-file-text"></i> 日志
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- YARN ResourceManager -->
                    <div class="col-md-4 mb-3">
                        <div class="card service-card">
                            <div class="card-body text-center">
                                <i class="bi bi-cpu service-icon text-info"></i>
                                <h5>ResourceManager</h5>
                                <span class="badge bg-success status-badge mb-3">运行中</span>
                                <p class="text-muted">管理集群资源分配</p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-danger" onclick="stopService('resourcemanager')">
                                        <i class="bi bi-stop-fill"></i> 停止
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="restartService('resourcemanager')">
                                        <i class="bi bi-arrow-clockwise"></i> 重启
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showLogs('resourcemanager')">
                                        <i class="bi bi-file-text"></i> 日志
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hive 服务 -->
                <h5 class="mb-3">Hive 服务</h5>
                <div class="row">
                    <!-- HiveServer2 -->
                    <div class="col-md-4 mb-3">
                        <div class="card service-card">
                            <div class="card-body text-center">
                                <i class="bi bi-server service-icon text-warning"></i>
                                <h5>HiveServer2</h5>
                                <span class="badge bg-danger status-badge mb-3">已停止</span>
                                <p class="text-muted">提供 Hive 查询服务</p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-success" onclick="startService('hiveserver2')">
                                        <i class="bi bi-play-fill"></i> 启动
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="restartService('hiveserver2')">
                                        <i class="bi bi-arrow-clockwise"></i> 重启
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showLogs('hiveserver2')">
                                        <i class="bi bi-file-text"></i> 日志
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hive Metastore -->
                    <div class="col-md-4 mb-3">
                        <div class="card service-card">
                            <div class="card-body text-center">
                                <i class="bi bi-database service-icon text-danger"></i>
                                <h5>Metastore</h5>
                                <span class="badge bg-warning status-badge mb-3">警告</span>
                                <p class="text-muted">管理元数据</p>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-outline-danger" onclick="stopService('metastore')">
                                        <i class="bi bi-stop-fill"></i> 停止
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="restartService('metastore')">
                                        <i class="bi bi-arrow-clockwise"></i> 重启
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="showLogs('metastore')">
                                        <i class="bi bi-file-text"></i> 日志
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 日志模态框 -->
<div class="modal fade" id="logModal" tabindex="-1" aria-labelledby="logModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logModalLabel">服务日志</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="service-logs" id="serviceLogContent">
                    <!-- 日志内容将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="refreshLogs()">刷新</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentService = '';
    // 服务状态映射
    const serviceStatus = {
        'namenode': 'running',
        'datanode': 'running',
        'resourcemanager': 'running',
        'hiveserver2': 'stopped',
        'metastore': 'warning'
    };
    
    // 更新服务状态显示
    function updateServiceStatus(service, status) {
        const badge = document.querySelector(`[onclick*="${service}"]`).closest('.card').querySelector('.status-badge');
        const buttons = document.querySelector(`[onclick*="${service}"]`).closest('.btn-group');
        
        // 更新状态标签
        badge.className = `badge status-badge mb-3 ${getStatusClass(status)}`;
        badge.textContent = getStatusText(status);
        
        // 更新按钮状态
        if (status === 'running') {
            buttons.innerHTML = `
                <button class="btn btn-outline-danger" onclick="stopService('${service}')">
                    <i class="bi bi-stop-fill"></i> 停止
                </button>
                <button class="btn btn-outline-primary" onclick="restartService('${service}')">
                    <i class="bi bi-arrow-clockwise"></i> 重启
                </button>
                <button class="btn btn-outline-secondary" onclick="showLogs('${service}')">
                    <i class="bi bi-file-text"></i> 日志
                </button>
            `;
        } else {
            buttons.innerHTML = `
                <button class="btn btn-outline-success" onclick="startService('${service}')">
                    <i class="bi bi-play-fill"></i> 启动
                </button>
                <button class="btn btn-outline-primary" onclick="restartService('${service}')">
                    <i class="bi bi-arrow-clockwise"></i> 重启
                </button>
                <button class="btn btn-outline-secondary" onclick="showLogs('${service}')">
                    <i class="bi bi-file-text"></i> 日志
                </button>
            `;
        }
        
        // 更新统计信息
        updateStatistics();
    }
    
    // 获取状态对应的CSS类
    function getStatusClass(status) {
        switch(status) {
            case 'running': return 'bg-success';
            case 'stopped': return 'bg-danger';
            case 'warning': return 'bg-warning';
            default: return 'bg-secondary';
        }
    }
    
    // 获取状态对应的文本
    function getStatusText(status) {
        switch(status) {
            case 'running': return '运行中';
            case 'stopped': return '已停止';
            case 'warning': return '警告';
            default: return '未知';
        }
    }
    
    // 更新统计信息
    function updateStatistics() {
        const counts = {
            running: 0,
            stopped: 0,
            warning: 0
        };
        
        Object.values(serviceStatus).forEach(status => {
            counts[status]++;
        });
        
        document.getElementById('runningCount').textContent = counts.running;
        document.getElementById('stoppedCount').textContent = counts.stopped;
        document.getElementById('warningCount').textContent = counts.warning;
        document.getElementById('totalCount').textContent = Object.keys(serviceStatus).length;
    }
    
    function startService(service) {
        if (confirm(`确定要启动 ${service} 服务吗？`)) {
            serviceStatus[service] = 'running';
            updateServiceStatus(service, 'running');
            // 这里可以添加发送AJAX请求到后端的代码
        }
    }
    
    function stopService(service) {
        if (confirm(`确定要停止 ${service} 服务吗？`)) {
            serviceStatus[service] = 'stopped';
            updateServiceStatus(service, 'stopped');
            // 这里可以添加发送AJAX请求到后端的代码
        }
    }
    
    function restartService(service) {
        if (confirm(`确定要重启 ${service} 服务吗？`)) {
            serviceStatus[service] = 'stopped';
            updateServiceStatus(service, 'stopped');
            
            // 模拟重启过程
            setTimeout(() => {
                serviceStatus[service] = 'running';
                updateServiceStatus(service, 'running');
            }, 2000);
            // 这里可以添加发送AJAX请求到后端的代码
        }
    }
    
    function showLogs(service) {
        currentService = service;
        const logContent = `[${new Date().toLocaleString()}] INFO: ${service} 服务${serviceStatus[service] === 'running' ? '运行中' : '已停止'}...\n[${new Date().toLocaleString()}] INFO: 内存使用率: ${Math.floor(Math.random() * 100)}%\n[${new Date().toLocaleString()}] INFO: 处理请求...`;
        
        document.getElementById('serviceLogContent').textContent = logContent;
        document.getElementById('logModalLabel').textContent = `${service} 服务日志`;
        
        const logModal = new bootstrap.Modal(document.getElementById('logModal'));
        logModal.show();
    }
    
    function refreshLogs() {
        const newLog = `[${new Date().toLocaleString()}] INFO: ${currentService} 服务${serviceStatus[currentService] === 'running' ? '运行正常' : '已停止'}\n[${new Date().toLocaleString()}] INFO: 内存使用率: ${Math.floor(Math.random() * 100)}%\n[${new Date().toLocaleString()}] INFO: 处理新请求...`;
        document.getElementById('serviceLogContent').textContent += '\n' + newLog;
    }
    
    function startAllServices() {
        if (confirm('确定要启动所有服务吗？')) {
            Object.keys(serviceStatus).forEach(service => {
                serviceStatus[service] = 'running';
                updateServiceStatus(service, 'running');
            });
            // 这里可以添加发送AJAX请求到后端的代码
        }
    }
    
    function stopAllServices() {
        if (confirm('确定要停止所有服务吗？')) {
            Object.keys(serviceStatus).forEach(service => {
                serviceStatus[service] = 'stopped';
                updateServiceStatus(service, 'stopped');
            });
            // 这里可以添加发送AJAX请求到后端的代码
        }
    }
    
    function refreshStatus() {
        // 这里可以添加发送AJAX请求到后端的代码
        // 目前只是更新显示
        updateStatistics();
    }
    
    // 初始化页面时更新所有服务状态
    document.addEventListener('DOMContentLoaded', function() {
        Object.entries(serviceStatus).forEach(([service, status]) => {
            updateServiceStatus(service, status);
        });
    });
</script>
{% endblock %} 