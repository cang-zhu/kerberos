{% extends "base.html" %}

{% block title %}系统配置{% endblock %}

{% block additional_style %}
<style>
    .card {
        margin-bottom: 20px;
    }
    .config-section {
        margin-bottom: 2rem;
    }
    .config-item {
        padding: 1rem;
        border-radius: 5px;
        background-color: #f8f9fa;
        margin-bottom: 1rem;
    }
    .config-value {
        font-family: monospace;
        background-color: #e9ecef;
        padding: 0.2rem 0.5rem;
        border-radius: 3px;
    }
    .log-content {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.85rem;
    }
    .system-info {
        padding: 1rem;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
    .tab-content {
        padding-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">系统配置</h5>
                <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 返回仪表板
                </a>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-2"></i> 在此页面您可以查看和修改系统的各项配置。
                </div>
                
                <!-- 选项卡导航 -->
                <ul class="nav nav-tabs" id="systemTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true">常规设置</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hadoop-tab" data-bs-toggle="tab" data-bs-target="#hadoop" type="button" role="tab" aria-controls="hadoop" aria-selected="false">Hadoop 配置</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hive-tab" data-bs-toggle="tab" data-bs-target="#hive" type="button" role="tab" aria-controls="hive" aria-selected="false">Hive 配置</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs" type="button" role="tab" aria-controls="logs" aria-selected="false">系统日志</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab" aria-controls="about" aria-selected="false">关于系统</button>
                    </li>
                </ul>
                
                <!-- 选项卡内容 -->
                <div class="tab-content" id="systemTabsContent">
                    <!-- 常规设置 -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">系统路径配置</h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="pathConfigForm">
                                            <div class="mb-3">
                                                <label for="hadoopHome" class="form-label">HADOOP_HOME</label>
                                                <input type="text" class="form-control" id="hadoopHome" value="/usr/local/hadoop">
                                            </div>
                                            <div class="mb-3">
                                                <label for="hiveHome" class="form-label">HIVE_HOME</label>
                                                <input type="text" class="form-control" id="hiveHome" value="/usr/local/hive">
                                            </div>
                                            <div class="mb-3">
                                                <label for="javaHome" class="form-label">JAVA_HOME</label>
                                                <input type="text" class="form-control" id="javaHome" value="/usr/lib/jvm/java-8-openjdk">
                                            </div>
                                            <div class="mb-3">
                                                <label for="logDir" class="form-label">日志目录</label>
                                                <input type="text" class="form-control" id="logDir" value="/var/log/hadoop">
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="savePathConfig()">保存配置</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">系统参数</h6>
                                    </div>
                                    <div class="card-body">
                                        <form id="systemParamsForm">
                                            <div class="mb-3">
                                                <label for="webPort" class="form-label">Web 服务端口</label>
                                                <input type="number" class="form-control" id="webPort" value="5002">
                                            </div>
                                            <div class="mb-3">
                                                <label for="sessionTimeout" class="form-label">会话超时时间 (分钟)</label>
                                                <input type="number" class="form-control" id="sessionTimeout" value="30">
                                            </div>
                                            <div class="mb-3">
                                                <label for="maxLogSize" class="form-label">最大日志文件大小 (MB)</label>
                                                <input type="number" class="form-control" id="maxLogSize" value="100">
                                            </div>
                                            <div class="mb-3 form-check">
                                                <input type="checkbox" class="form-check-input" id="debugMode" checked>
                                                <label class="form-check-label" for="debugMode">调试模式</label>
                                            </div>
                                            <button type="button" class="btn btn-primary" onclick="saveSystemParams()">保存配置</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hadoop 配置 -->
                    <div class="tab-pane fade" id="hadoop" role="tabpanel" aria-labelledby="hadoop-tab">
                        <div class="config-section">
                            <h6 class="mb-3">core-site.xml</h6>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">fs.defaultFS</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">hdfs://localhost:9000</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('fs.defaultFS')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">hadoop.tmp.dir</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">/home/hadoop/tmp</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('hadoop.tmp.dir')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="config-section">
                            <h6 class="mb-3">hdfs-site.xml</h6>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">dfs.replication</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">1</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('dfs.replication')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">dfs.namenode.name.dir</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">/home/hadoop/hdfs/namenode</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('dfs.namenode.name.dir')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">dfs.datanode.data.dir</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">/home/hadoop/hdfs/datanode</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('dfs.datanode.data.dir')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end mt-3">
                            <button class="btn btn-success" onclick="saveHadoopConfig()">保存所有配置</button>
                            <button class="btn btn-warning" onclick="restartHadoopServices()">重启 Hadoop 服务</button>
                        </div>
                    </div>
                    
                    <!-- Hive 配置 -->
                    <div class="tab-pane fade" id="hive" role="tabpanel" aria-labelledby="hive-tab">
                        <div class="config-section">
                            <h6 class="mb-3">hive-site.xml</h6>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">javax.jdo.option.ConnectionURL</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">jdbc:derby:;databaseName=/home/hadoop/hive/metastore_db;create=true</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('javax.jdo.option.ConnectionURL')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">hive.metastore.warehouse.dir</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">/user/hive/warehouse</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('hive.metastore.warehouse.dir')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="config-item">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <span class="fw-bold">hive.server2.thrift.port</span>
                                    </div>
                                    <div class="col-md-6">
                                        <span class="config-value">10000</span>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editConfig('hive.server2.thrift.port')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-end mt-3">
                            <button class="btn btn-success" onclick="saveHiveConfig()">保存所有配置</button>
                            <button class="btn btn-warning" onclick="restartHiveServices()">重启 Hive 服务</button>
                        </div>
                    </div>
                    
                    <!-- 系统日志 -->
                    <div class="tab-pane fade" id="logs" role="tabpanel" aria-labelledby="logs-tab">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <select class="form-select me-2" id="logType">
                                        <option value="system">系统日志</option>
                                        <option value="hadoop">Hadoop 日志</option>
                                        <option value="hive">Hive 日志</option>
                                        <option value="security">安全日志</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="loadLogs()">加载日志</button>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary" onclick="clearLogs()">清空日志</button>
                                <button class="btn btn-outline-primary" onclick="downloadLogs()">下载日志</button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0" id="logTitle">系统日志</h6>
                            </div>
                            <div class="card-body">
                                <div class="log-content" id="logContent">
                                    2025-03-26 20:10:15 INFO: 系统启动...<br>
                                    2025-03-26 20:10:16 INFO: 加载配置文件...<br>
                                    2025-03-26 20:10:18 INFO: 初始化数据库连接...<br>
                                    2025-03-26 20:10:20 INFO: 检查服务状态...<br>
                                    2025-03-26 20:10:22 INFO: 启动Web服务...<br>
                                    2025-03-26 20:10:25 INFO: 系统准备就绪，监听端口 5002<br>
                                    2025-03-26 20:12:30 INFO: 用户'admin'登录系统<br>
                                    2025-03-26 20:15:45 INFO: 检查HDFS服务状态: 运行中<br>
                                    2025-03-26 20:15:46 INFO: 检查YARN服务状态: 运行中<br>
                                    2025-03-26 20:15:47 INFO: 检查Hive服务状态: 已停止<br>
                                    2025-03-26 20:18:10 WARNING: 尝试启动Hive服务...<br>
                                    2025-03-26 20:18:30 ERROR: Hive服务启动失败: 连接数据库错误<br>
                                    2025-03-26 20:20:15 WARNING: 用户'admin'修改系统配置<br>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 关于系统 -->
                    <div class="tab-pane fade" id="about" role="tabpanel" aria-labelledby="about-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">系统信息</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="system-info">
                                            <p><strong>系统名称:</strong> Kerberos 认证管理系统</p>
                                            <p><strong>版本:</strong> 1.0.0</p>
                                            <p><strong>构建日期:</strong> 2025-03-15</p>
                                            <p><strong>运行环境:</strong> Python 3.8, Flask 2.0.1</p>
                                            <p><strong>数据库:</strong> SQLite 3.36.0</p>
                                            <p><strong>操作系统:</strong> Linux Ubuntu 20.04 LTS</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">组件版本</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="system-info">
                                            <p><strong>Hadoop:</strong> 3.3.1</p>
                                            <p><strong>Hive:</strong> 3.1.2</p>
                                            <p><strong>Kerberos:</strong> MIT Kerberos 5-1.18</p>
                                            <p><strong>Java:</strong> OpenJDK 1.8.0_292</p>
                                            <p><strong>Web 框架:</strong> Bootstrap 5.1.3</p>
                                            <p><strong>安全验证:</strong> TOTP 身份验证</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">系统状态</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 text-center">
                                        <div class="p-3">
                                            <h3 id="cpuUsage">32%</h3>
                                            <p class="text-muted mb-0">CPU 使用率</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="p-3">
                                            <h3 id="memoryUsage">45%</h3>
                                            <p class="text-muted mb-0">内存使用率</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="p-3">
                                            <h3 id="diskUsage">28%</h3>
                                            <p class="text-muted mb-0">磁盘使用率</p>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-center">
                                        <div class="p-3">
                                            <h3 id="uptime">3天</h3>
                                            <p class="text-muted mb-0">系统运行时间</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-primary" onclick="refreshSystemStatus()">刷新状态</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 配置编辑模态框 -->
<div class="modal fade" id="configEditModal" tabindex="-1" aria-labelledby="configEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configEditModalLabel">编辑配置</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="configEditForm">
                    <div class="mb-3">
                        <label for="configKey" class="form-label">配置项</label>
                        <input type="text" class="form-control" id="configKey" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="configValue" class="form-label">配置值</label>
                        <input type="text" class="form-control" id="configValue">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveConfigValue()">保存</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function savePathConfig() {
        alert('系统路径配置已保存');
    }
    
    function saveSystemParams() {
        alert('系统参数已保存');
    }
    
    function editConfig(key) {
        document.getElementById('configKey').value = key;
        
        // 根据 key 获取当前值（这里只是演示，实际应该从后端获取）
        let value = '';
        const keyElements = document.querySelectorAll('.fw-bold');
        keyElements.forEach((el) => {
            if (el.textContent === key) {
                const valueEl = el.closest('.row').querySelector('.config-value');
                if (valueEl) {
                    value = valueEl.textContent;
                }
            }
        });
        
        document.getElementById('configValue').value = value;
        
        // 显示模态框
        const configEditModal = new bootstrap.Modal(document.getElementById('configEditModal'));
        configEditModal.show();
    }
    
    function saveConfigValue() {
        const key = document.getElementById('configKey').value;
        const value = document.getElementById('configValue').value;
        
        alert(`保存配置项: ${key} = ${value}`);
        
        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('configEditModal'));
        modal.hide();
        
        // 更新页面显示的值
        const keyElements = document.querySelectorAll('.fw-bold');
        keyElements.forEach((el) => {
            if (el.textContent === key) {
                const valueEl = el.closest('.row').querySelector('.config-value');
                if (valueEl) {
                    valueEl.textContent = value;
                }
            }
        });
    }
    
    function saveHadoopConfig() {
        alert('Hadoop 配置已保存');
    }
    
    function restartHadoopServices() {
        if (confirm('确定要重启 Hadoop 服务吗？这可能会暂时中断相关服务。')) {
            alert('正在重启 Hadoop 服务');
        }
    }
    
    function saveHiveConfig() {
        alert('Hive 配置已保存');
    }
    
    function restartHiveServices() {
        if (confirm('确定要重启 Hive 服务吗？这可能会暂时中断相关服务。')) {
            alert('正在重启 Hive 服务');
        }
    }
    
    function loadLogs() {
        const logType = document.getElementById('logType').value;
        document.getElementById('logTitle').textContent = document.getElementById('logType').options[document.getElementById('logType').selectedIndex].text;
        alert(`加载 ${logType} 日志`);
    }
    
    function clearLogs() {
        if (confirm('确定要清空当前日志吗？这将永久删除日志内容。')) {
            document.getElementById('logContent').innerHTML = '日志已清空';
        }
    }
    
    function downloadLogs() {
        const logType = document.getElementById('logType').value;
        alert(`下载 ${logType} 日志`);
    }
    
    function refreshSystemStatus() {
        // 模拟更新系统状态数据
        document.getElementById('cpuUsage').textContent = Math.floor(Math.random() * 40 + 20) + '%';
        document.getElementById('memoryUsage').textContent = Math.floor(Math.random() * 30 + 30) + '%';
        document.getElementById('diskUsage').textContent = Math.floor(Math.random() * 20 + 20) + '%';
        alert('系统状态已刷新');
    }
</script>
{% endblock %} 